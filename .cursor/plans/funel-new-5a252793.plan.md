<!-- 5a252793-4b65-419c-bd3e-7d95865a84ad e3b5b233-5dd1-4e64-8460-e57a2a3a4774 -->
# План: Реализация ожидания ответного webhook от n8n с SSE

## Задача

Реализовать механизм асинхронной обработки: после отправки данных в n8n клиент ожидает результат через SSE, n8n отправляет результат на callback endpoint, клиент получает готовую ссылку на страницу результата и перенаправляется.

## Архитектура

1. **Клиент отправляет данные** → `/api/analyze` → создается `session_id` → данные отправляются в n8n
2. **n8n обрабатывает** → отправляет результат на `/api/webhook/callback` с `session_id` и `result_url`
3. **Сервер сохраняет результат** → отправляет через SSE клиенту
4. **Клиент получает результат** → перенаправляет на `result_url`

## Файлы для создания/изменения

### 1. `/app/api/webhook/callback/route.ts` (новый)

- Принимает POST от n8n с результатами
- Сохраняет результат в in-memory storage (Map)
- Отправляет событие через SSE всем подключенным клиентам с этим session_id
- Проверяет секретный ключ (опционально)

### 2. `/app/api/analyze/status/[sessionId]/route.ts` (новый)

- SSE endpoint для получения результатов в реальном времени
- Подключается к EventSource на клиенте
- Отправляет события когда результат готов

### 3. `/app/api/analyze/route.ts` (изменить)

- Генерирует уникальный `session_id` (UUID)
- Добавляет `session_id` в данные для n8n
- Возвращает `session_id` клиенту сразу (не ждет результат)
- Не блокирует запрос на 120 секунд

### 4. `/app/app/page.tsx` (изменить)

- После успешной отправки данных создает EventSource для SSE
- Подписывается на события по `session_id`
- При получении результата перенаправляет на `result_url`
- Показывает индикатор загрузки во время ожидания
- Обрабатывает ошибки и таймауты

### 5. In-memory storage (новый файл или в route)

- Map для хранения результатов: `Map<session_id, { result_url, status, createdAt }>`
- Очистка старых записей (TTL ~10 минут)

## Структура данных

### Запрос от n8n на `/api/webhook/callback`:

```json
{
  "session_id": "uuid-here",
  "status": "completed",
  "result_url": "https://domain.com/result?color_temperature=cool&color_season=cool_summer&...",
  "error": null
}
```

### Ответ от `/api/analyze`:

```json
{
  "success": true,
  "session_id": "uuid-here"
}
```

### SSE событие:

```
event: result
data: {"session_id": "uuid", "result_url": "...", "status": "completed"}
```

## Безопасность

- Опциональная проверка секретного ключа в callback endpoint
- Валидация session_id формата (UUID)
- TTL для результатов (автоочистка через 10 минут)

## Обработка ошибок

- Таймаут ожидания (например, 5 минут)
- Обработка ошибок от n8n
- Fallback на показ сообщения "Результат придет в Telegram"

## Настройка n8n

В n8n workflow после обработки добавить HTTP Request Node:

- URL: `https://ваш-домен.vercel.app/api/webhook/callback`
- Method: POST
- Body: JSON с `session_id`, `status`, `result_url`

### To-dos

- [ ] Создать заголовок и описание проекта с технологическим стеком
- [ ] Добавить раздел быстрого старта с требованиями
- [ ] Добавить раздел конфигурации с переменными окружения
- [ ] Добавить детальное описание структуры проекта
- [ ] Добавить описание основных функций
- [ ] Добавить документацию API endpoints
- [ ] Добавить описание компонентов
- [ ] Добавить раздел об интеграциях
- [ ] Добавить раздел об обработке изображений
- [ ] Добавить подробную инструкцию по деплою
- [ ] Добавить раздел о n8n workflow
- [ ] Добавить раздел troubleshooting
- [ ] Добавить дополнительную информацию и ссылки
- [ ] Создать заголовок и описание проекта с технологическим стеком
- [ ] Добавить раздел быстрого старта с требованиями
- [ ] Добавить раздел конфигурации с переменными окружения
- [ ] Добавить детальное описание структуры проекта
- [ ] Добавить описание основных функций
- [ ] Добавить документацию API endpoints
- [ ] Добавить описание компонентов
- [ ] Добавить раздел об интеграциях
- [ ] Добавить раздел об обработке изображений
- [ ] Добавить подробную инструкцию по деплою
- [ ] Добавить раздел о n8n workflow
- [ ] Добавить раздел troubleshooting
- [ ] Добавить дополнительную информацию и ссылки
- [ ] Обновить типы в funel_new/types/result.ts - добавить gender и age
- [ ] Обновить валидацию в funel_new/app/result/page.tsx
- [ ] Создать функцию getColorSeasonImagePath в funel_new/lib/dictionaries.ts
- [ ] Обновить компонент ColorSeasonBlock - добавить пропсы и фото
- [ ] Обновить страницу результата - передать параметры
- [ ] Добавить стили для фото в globals.css
- [ ] Создать /app/api/webhook/callback/route.ts для приема результатов от n8n
- [ ] Создать /app/api/analyze/status/[sessionId]/route.ts для SSE подключений
- [ ] Создать in-memory storage для результатов (Map с TTL)
- [ ] Обновить /app/api/analyze/route.ts: генерировать session_id и возвращать его сразу
- [ ] Обновить /app/app/page.tsx: добавить SSE подключение и обработку результатов
- [ ] Добавить UI индикатор загрузки во время ожидания результата
- [ ] Протестировать полный flow: отправка → ожидание → получение результата → редирект